name: Deploy.Application

on:
  repository_dispatch:
    types: [artifacts-published]

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Use official SSH action (safer and cleaner than manual setup)
      - name: Setup SSH connection
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # âœ… Add known hosts (avoids "host authenticity" prompt)
      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # âœ… Pull the new Docker image on remote server
      - name: Pull latest Docker image
        run: |
          echo "ðŸ”„ Pulling Docker image for version: ${{ github.event.client_payload.ref }}"
          ssh -i ${{ secrets.SSH_KEYPAIR_NAME }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            echo '${{ secrets.GHCR_TOKEN }}' | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin &&
            docker pull ghcr.io/${{ github.repository_owner }}/next-boilerplate-251001:${{ github.event.client_payload.ref }}"

      # âœ… Deploy container (stop old, start new)
      - name: Deploy container
        run: |
          echo "ðŸš€ Deploying version: ${{ github.event.client_payload.ref }}"
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            set -e
            docker stop next-boilerplate-frontend 2>/dev/null || true
            docker rm next-boilerplate-frontend 2>/dev/null || true
            docker run -d \
              --name next-boilerplate-frontend \
              --restart=always \
              -p 3000:3000 \
              --env-file /opt/next-boilerplate/.env \
              ghcr.io/${{ github.repository_owner }}/next-boilerplate-251001:${{ github.event.client_payload.ref }}
          "

      # âœ… Verify the new container is running and healthy
      - name: Verify deployment
        run: |
          echo "âœ… Verifying deployment..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            docker ps --filter name=next-boilerplate-frontend --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}'
          "
