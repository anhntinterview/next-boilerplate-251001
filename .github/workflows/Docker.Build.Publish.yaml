name: Docker.Build.Publish

on:
  workflow_call:
    inputs:
      dockerfile_path:
        required: false
        default: ./Dockerfile
        type: string
      image_tag:
        required: false
        default: latest
        type: string
      image_subdirectory:
        required: false
        default: "."
        type: string
      run_docker_publish:
        required: false
        default: true
        type: boolean
jobs:
  docker-build-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: ${{inputs.run_docker_publish}}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          CONTAINER_NAME="${{ secrets.CONTAINER_NAME }}"
          [ -z "$CONTAINER_NAME" ] && CONTAINER_NAME="nest-boilerplate-251027"
          IMAGE="ghcr.io/${{ github.repository_owner }}/$CONTAINER_NAME:${{ inputs.image_tag }}"
          echo "🏗️ Building image: $IMAGE"
          docker build \
            -f "${{ inputs.dockerfile_path }}" \
            -t "$IMAGE" \
            "${{ inputs.image_subdirectory }}"

      - name: Push Docker image to GHCR
        if: ${{ inputs.run_docker_publish == true }}
        env:
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          set -e
          IMAGE="ghcr.io/${{ github.repository_owner }}/${CONTAINER_NAME}:${IMAGE_TAG}"
          echo "🚀 Pushing image: $IMAGE"
          docker push "$IMAGE" >/dev/null
